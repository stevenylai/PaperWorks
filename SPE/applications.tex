\section{Application Scenarios}
\label{sec:pswareImpl}
In previous sections, we have introduced PSWare and how it can be customized to meet different application requirements. In this section, we demonstrate how PSWare can help in developing practical WNS applications through three application case studies: the indoor monitoring, the car park and the intelligent transportation system.

The key features of the three applications are as follows:
\begin{itemize}
\item Energy efficiency in an indoor monitoring system is crucial because the network needs to operate for a long period of time and it is not necessary to gather all the raw data.
\item Reliability is important in a car park system because the management system needs to know the time when each car enters and leaves the car park so as to calculate the fee.
\item Event detection and delivery mechanism may be tailor-made for an ITS system because transportation network has certain special 
\end{itemize}

\subsection{Applications Overview}
Indoor environment monitoring uses WSN for monitoring because it is easy to deploy the sensor nodes. Such application domain has many applications including air-conditioning, fire alarm and office space light adjustment. Such system is a good application for using composite events because of the following characteristics:
\begin{itemize}
\item There may be a large amount of raw data since the data may be gathered from a lot of sources.
\item The users may not be interested in all the raw data. Instead, they may be more interested in change of the data. This is because the events such as fire or temperature change will usually trigger the change of the sensory data. 
\item Primitive event detection may not be sufficient. For instance, a fire alarm may be characterized by a combination of different types of events such as temperature and light.
\end{itemize}

In the area of intelligent transportation system (ITS), WSN also finds many applications because it is easy to deploy the sensor nodes without interrupting the traffic. This application also has a lot of applications including collision avoidance, traffic light control, automatic road enforcement and electronic toll. Composite event detection is very common in these applications because one of the common requirements for these applications is to detect the speed of vehicle. However, different from the indoor temperature and light monitoring, the ITS applications have the following characteristics:
\begin{itemize}
\item The magnetic sensor used in ITS application will consume much more energy so the energy consumption from sensing may not be negligible. This will affect the event detection method for ITS.
\item The sensor nodes are deployed and lined up on each road and will detect each passing vehicle one by one. Such special deployment may also affect the event detection method.
\item Events may need to be delivered to mobile sinks instead of a fixed point.
\item Different types of events may require different event delivery methods. Urgent events such as accident may need to be disseminated in a real time fashion while events such as road condition and weather information may be delivered in a delay tolerant fashion.
\end{itemize}

Intelligent car park systems is an application domain which is related to ITS. However, it is different from other ITS applications in the following ways:
\begin{itemize}
\item The detected events usually need to be delivered to a central management center instead of to mobile vehicles.
\item The deployment of the sensor nodes is different. In a car park system, it is usually not necessary to deploy the sensor nodes on the roads. Instead, they are usually deployed in individual parking space to keep track of availability of them.
\item Different from other ITS applications, the event delay in intelligent car park is not as important. Message delay for a couple of seconds is probably acceptable.
\end{itemize}

On the other hand, a car park system is also different from our first indoor application in the sense that:
\begin{itemize}
\item Each message must be reliably delivered so that the management system can correctly record the entrance and exit time and calculate the parking fee.
\item The environment for message transmission may be harsh because cars are usually made of metal. Therefore, message lost may be common.
\end{itemize}
To meet the reliability requirement, we need to implement special event detection and delivery mechanisms so that the events can be reliably detected and delivered in such an unreliable environment.

\subsection{Discussion}
The requirements for the indoor monitoring application can be met with TED since the primary goal of TED is to reduce energy consumption by filtering the events which will not lead to the detection of subscribed composite events. To have a practical application scenario, we deployed our sensor nodes around the Internet and Mobile Computing Laboratory of the Hong Kong Polytechnic University. The deployment plan is shown in Figure \ref{fig:indoorDeployment}.

\begin{figure}
\centering
\figurecurrentwidth{indoorDeployment}
\caption{Deployment of the senosr nodes for indoor monitoring}
\label{fig:indoorDeployment}
\end{figure}

We use this deployment for two applications: fire detection and temperature control. Since it is infeasible to transmit all the raw data to the sink, some nodes in the network will have be used as local decision maker and detect the composite event. As a result, developing the application will involve the following steps:
\begin{enumerate}
\item Deploy the network and select the appropriate sensor nodes as event fusion points using the fusion point selection algorithm in TED.
\item Subscribe the desired events through PSWare.
\item Detect the composite events with PSWare.
\item Automatically let the nodes switch between different event fusion points to achieve high efficiency.
\end{enumerate}

To monitor the temperature change of the entire floor and adjust the air-conditioner accordingly, we need to define a composite event that comprises of the sub-events for individual room. For example, the air conditioner can be adjusted if several adjacent rooms' temperature rises too fast. The primitive and composite event definitions for this purpose are shown in Listing \ref{prog:indoorEvents}.

\begin{lstlisting}[caption=Event definition for temperature monitoring, label=prog:indoorEvents]
Event SingleTemp {
	int id=System.id;
	int temperature=System.temperature;
} where {
	temperature>THRESHOLD
}
Event CompositeTemp {
} on {
	SingleTemp e1, e2, e3;
} where {
	e1.id==1 &&
	e2.id==2 &&
	abs(e1.time - e2.time)<TIME_INTERVAL
}
\end{lstlisting}

The primitive event simply tests if the temperature passes certain threshold while the composite event is the conjunction of several primitive events. We deployed the some Micaz nodes in different rooms in our building as shown in Figure \ref{fig:indoorDeployment}.

For fire alarm, the composite event definition is based on both light and temperature readings. The event definition is shown in Listing \ref{prog:indoorFire}.
\begin{lstlisting}[caption=Event definition for fire alarm, label=prog:indoorFire]
Event Temperature {
	int id=System.id;
	int temperature=System.temperature;
} where {
	temperature>THRESHOLD_TEMP
}
Event Light {
	int id=System.id;
	int light=System.light;
} where {
	light>THRESHOLD_LIGHT
}
Event Fire {
} on {
	Temperature temp;
	Light light;
} where {
	e1.id==light.id
}
\end{lstlisting}

\begin{figure}
\centering
\subfloat[Road side sensor nodes]{\label{fig:itsSensor1}\figurehalfwidth{itsSensor1}}
\subfloat[Sensor nodes on the lamp]{\label{fig:itsSensor2}\figurehalfwidth{itsSensor2}}
\caption{Sensor nodes for transportation systems}
\label{fig:itsSensor}
\end{figure}

While TED works fine for indoor applications, it is not suitable for ITS. Because its unique characteristics as described in the previous subsection, we need to implement different event detection algorithm so as to improve its efficiency. Because of the high energy cost of sensing, the sensor nodes will turn their sensors off for most of the time while keeping their radio on so that they can know when to start sensing. Furthermore, sensor nodes are deployed along the roads and events are also forwarded along the roads so that . The procedure for nodes' wake-up and forwarding is shown in Procedure \ref{algo:itsForward}. We use the following notations in the procedure:
\begin{itemize}
\item \(V=\{v_1, v_2 \cdots \}\): the sensor nodes that come next on the road. For the sensors on the road, \(\|V\|=1\) but for the sensors next to the crossroads, \(\|V\|>1\)
\item Vehicle events \(e_i\) which are either detected locally or received from another node.
\end{itemize}

\begin{algorithm}
\begin{algorithmic}
	\IF {detected vehicle event \(e_i\)}
		\FORALL {\(v_n\in V\)}
			\STATE forward \(e_i\) to \(v_n\)
		\ENDFOR
	\ENDIF
	\IF {received vehicle event \(e_i\) from \(v_m\)}
		\STATE start data collection
		\IF {detected vehicle event \(e_j\)}
			\STATE select \(e_i\) and \(e_j\) for composite event detection
		\ELSE
			\STATE wait for event to expire
		\ENDIF
		\STATE stop data collection
	\ENDIF
\end{algorithmic}
\caption{Event forwarding for ITS}
\label{algo:itsForward}
\end{algorithm}

In the actual application deployment as illustrated in Figure \ref{fig:itsSensor}, we use some sentry nodes at the entrances of the deployed area. These nodes have more power and will monitor the entrance for newly entered cars. Except for the sentry node, the nodes will not actively collect data until it receives messages from others. Once the event from the previous node on the road is received, it will be selected for composite event detection.

As for the event definition in ITS applications, we will illustrate one of the basic events used in such applications: the tracking for vehicles. The event definition is shown in Listing \ref{lst:carEvent}.

\begin{lstlisting}[caption=Event definition for tracking vehicles, label=lst:carEvent]
Event CarEvent {
	int time=System.time;
	int magnetic=System.magnetic;
	int location=System.location;
} where {
	magnetic>THRESHOLD
}
Event SpeedEvent { (* \label{lst:carEvent:speed} *)
	int speed=(e1.location-e2.location)/(e1.time-e2.time);
} on {
	CarEvent e1, e2;
} where {
	e1.time>e2.time &&
	speed>THRESHOLD
}
\end{lstlisting}

First, an event named 'CarEvent' is defined to detect the presence of the individual vehicles. Then based on this event, we can define a composite event to measure the speed of the car as on Line \ref{lst:carEvent:speed}.

\begin{figure}
\centering
\subfloat[The sensor node]{\label{fig:carParkSensor1}\figurehalfwidth{carParkSensor1}}
\subfloat[The light sensor]{\label{fig:carParkSensor2}\figurehalfwidth{carParkSensor2}}
\caption{Car park sensor platform}
\label{fig:carParkSensor}
\end{figure}

We used the campus car park as our test bed for intelligent car park system applications. We deployed some micaz sensor nodes for the application. For simplicity, we use light sensor to detect the presence of a vehicle. For better communication, the sensor nodes are attached close to the ceiling instead of on the ground. The light sensor on each node is connected through an extended cable as shown in Figure \ref{fig:carParkSensor}. 

\begin{figure}
\centering
\figurecurrentwidth{carParkDeployment}
\caption{Car park sensor deployment}
\label{fig:carParkDeployment}
\end{figure}

The deployment of the individual sensor nodes is shown in Figure \ref{fig:carParkDeployment}. In such a system, the management is interested in the number of park spaces and the location of them \cite{tang:carpark}. Therefore, each parking space is monitored by one sensor node.
The primitive events for such a system will be the availability of individual car park spaces. Based on the primitive event, if we want to get notified when the parking spaces near the exit become available, then we just need to define composite events which locate the spaces with certain IDs. Th event definitions are shown in Listing \ref{prog:carPark}. Here, the composite event takes two primitive events for parking space \(1\) and \(2\) which are close to the exit.

\begin{lstlisting}[caption=Event definition for a car park, label=prog:carPark]
Event ParkSpaceEvent {
	int id=System.id;
	int time=System.time;
	int light=System.light;
} where {
	light>THRESHOLD
}
Event CarParkEvent {
	int id=System.id;
} on {
	ParkSpaceEvent e1, e2;
} where {
	e1.id==1 ||
	e2.id==2 ||
	e1.time-e2.time<10
}\end{lstlisting}